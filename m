Return-Path: <linux-arch-owner@vger.kernel.org>
X-Original-To: lists+linux-arch@lfdr.de
Delivered-To: lists+linux-arch@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.lfdr.de (Postfix) with ESMTP id 6E0CC15271A
	for <lists+linux-arch@lfdr.de>; Wed,  5 Feb 2020 08:39:05 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727083AbgBEHjF (ORCPT <rfc822;lists+linux-arch@lfdr.de>);
        Wed, 5 Feb 2020 02:39:05 -0500
Received: from mail-pg1-f195.google.com ([209.85.215.195]:46939 "EHLO
        mail-pg1-f195.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727068AbgBEHjE (ORCPT
        <rfc822;linux-arch@vger.kernel.org>); Wed, 5 Feb 2020 02:39:04 -0500
Received: by mail-pg1-f195.google.com with SMTP id z124so520160pgb.13
        for <linux-arch@vger.kernel.org>; Tue, 04 Feb 2020 23:39:03 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=date:message-id:from:to:cc:subject:in-reply-to:references
         :user-agent:mime-version;
        bh=wPNxZNcefQtXGqNsqQ4bOqLtRzkFN8K5CMyJqD0vjr0=;
        b=QJghL7Up5Q6HpJVVz9MOUcXi+ETC1cfg2rFFFnWeaK6jcdKcP50v/Nvp1Q7HiC4DzJ
         yi/dpNcgFvNkvAekJNPELoFXFNPKTfiq1oo6dtzdvMeLTybVryCPs1BHWMPpZTRvOdA1
         5un92RmnvBwYVAukoxv/B6/JGYMgUUW68/e/C/dKn3P7nNkuicVwLoVRtojLqQqjDPHm
         c+8fQ7csp4RRb1A/8BxnNcxy/odGXq0DezyDxPoz5J+HVqA5mcgijpyjDbqy0YFc2MkU
         VG+0dagz67+h+H1UumWxsE2b5PVj6lH0JEdwc1apzKbiLb8CD0BDtsCtVRBYNufgERZt
         9RZQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:date:message-id:from:to:cc:subject:in-reply-to
         :references:user-agent:mime-version;
        bh=wPNxZNcefQtXGqNsqQ4bOqLtRzkFN8K5CMyJqD0vjr0=;
        b=AnKHz75iEHLVMFa267O/z72OxcozDWg3xRQNaQC8Fyb4QIlcsBHnCJdHWh52xQDoYN
         f7xhTGUPQnM8m+wUhV4N9LHUTsa96qg1c+2fqMfTQSye+rL4O5NcIV0b7YFkA+lY2NRJ
         F/nOhO1bBnd2tu+MqPwji5FdIPzsPjASP4Hl6Od4ShBXVZ2hcmpqYsLT0c46+c7tdwPb
         z9Vwqwda37kn8K5h3XAbq59fza4nFv9Du30XdpfnEoncmYQ2uyvbwJb3WDZQRDVwmrKc
         UabTo/UaDHPA09nc3Lleihk9LhmX+ZYRxV5T9+xQoFIaXH5hsoFFCkUWcItTIjAjYJg2
         lsOg==
X-Gm-Message-State: APjAAAV67YGQSNB8J/oV7Bx1lt7C0bEdH/Opd+R0RxoAKu71L4wB0zDX
        f2ZEoWQWlnne1OsMk8U5Jqc=
X-Google-Smtp-Source: APXvYqzPKFZIr3Y0tBQOBcxX8tIzevY3XsC0dSf78u7juBZdrhqOtherzRKZNoKjBsHrh+GUuTpAuA==
X-Received: by 2002:a63:360a:: with SMTP id d10mr34546187pga.366.1580888342495;
        Tue, 04 Feb 2020 23:39:02 -0800 (PST)
Received: from earth-mac.local.gmail.com ([202.214.86.179])
        by smtp.gmail.com with ESMTPSA id y16sm26663001pfn.177.2020.02.04.23.39.00
        (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
        Tue, 04 Feb 2020 23:39:02 -0800 (PST)
Date:   Wed, 05 Feb 2020 16:38:58 +0900
Message-ID: <m2h805qy99.wl-thehajime@gmail.com>
From:   Hajime Tazaki <thehajime@gmail.com>
To:     richard.weinberger@gmail.com
Cc:     linux-um@lists.infradead.org, linux-arch@vger.kernel.org,
        tavi.purdila@gmail.com, retrage01@gmail.com,
        linux-kernel-library@freelists.org, sigmaepsilon92@gmail.com
Subject: Re: [RFC v2 07/37] lkl: interrupt support
In-Reply-To: <CAFLxGvxytmS4WSFj2ibyJKCuR5TbspdNf6MvHNvzh9dtKx2rJg@mail.gmail.com>
References: <cover.1573179553.git.thehajime@gmail.com>
        <567fd4d5c395e2279e86ca0bfca544ad2773a31d.1573179553.git.thehajime@gmail.com>
        <CAFLxGvxytmS4WSFj2ibyJKCuR5TbspdNf6MvHNvzh9dtKx2rJg@mail.gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) Emacs/25.3 Mule/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-arch-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-arch.vger.kernel.org>
X-Mailing-List: linux-arch@vger.kernel.org


On Tue, 26 Nov 2019 07:13:55 +0900,
Richard Weinberger wrote:
> 
> On Fri, Nov 8, 2019 at 6:03 AM Hajime Tazaki <thehajime@gmail.com> wrote:
> >
> > From: Octavian Purdila <tavi.purdila@gmail.com>
> >
> > Add APIs that allows the host to reserve and free and interrupt number
> > and also to trigger an interrupt.
> >
> > The trigger operation will simply store the interrupt data in
> > queue. The interrupt handler is run later, at the first opportunity it
> > has to avoid races with any kernel threads.
> >
> > Currently, interrupts are run on the first interrupt enable operation
> > if interrupts are disabled and if we are not already in interrupt
> > context.
> >
> > When triggering an interrupt, it uses GCC's built-in functions for
> > atomic memory access to synchronize and simple boolean flags.
> >
> > Signed-off-by: Hajime Tazaki <thehajime@gmail.com>
> > Signed-off-by: Michael Zimmermann <sigmaepsilon92@gmail.com>
> > Signed-off-by: Octavian Purdila <tavi.purdila@gmail.com>
> > ---
> >  arch/um/lkl/include/asm/irq.h             |  13 ++
> >  arch/um/lkl/include/uapi/asm/irq.h        |  36 ++++
> >  arch/um/lkl/include/uapi/asm/sigcontext.h |  16 ++
> >  arch/um/lkl/kernel/irq.c                  | 193 ++++++++++++++++++++++
> 
> Like I said before, this also something to unify with UML.
> I'm aware that this is easily said but we cannot have too much duplication.
> 
> Feel free to ask if UML internals give you headache. :-)

Same as nommu implementation, I left this part as-is.

Triggering interrupts with fd events (delivered by epoll&co) is a hard
part to implement host-independent interrupts of LKL.  OTOH, the v3
patchset shows that it is doable to use UML drivers with the LKL
interrupt facility.

I may also need more time to evaluate/find a right direction, though.
Your comments are always welcome.

-- Hajime

